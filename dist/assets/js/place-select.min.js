( function($) {

  // wc_city_select_params is required to continue, ensure the object exists
  // wc_country_select_params is used for select2 texts. This one is added by WC
  if ( typeof wc_country_select_params === 'undefined' || typeof wc_city_select_params === 'undefined' ) {
    return false;
  }

  function getEnhancedSelectFormatString() {
      return  {
      formatMatches: function( matches ) {
        if ( 1 === matches ) {
          return wc_country_select_params.i18n_matches_1;
        }

        return wc_country_select_params.i18n_matches_n.replace( '%qty%', matches );
      },
      formatNoMatches: function() {
        return wc_country_select_params.i18n_no_matches;
      },
      formatAjaxError: function() {
        return wc_country_select_params.i18n_ajax_error;
      },
      formatInputTooShort: function( input, min ) {
        var number = min - input.length;

        if ( 1 === number ) {
          return wc_country_select_params.i18n_input_too_short_1;
        }

        return wc_country_select_params.i18n_input_too_short_n.replace( '%qty%', number );
      },
      formatInputTooLong: function( input, max ) {
        var number = input.length - max;

        if ( 1 === number ) {
          return wc_country_select_params.i18n_input_too_long_1;
        }

        return wc_country_select_params.i18n_input_too_long_n.replace( '%qty%', number );
      },
      formatSelectionTooBig: function( limit ) {
        if ( 1 === limit ) {
          return wc_country_select_params.i18n_selection_too_long_1;
        }

        return wc_country_select_params.i18n_selection_too_long_n.replace( '%qty%', limit );
      },
      formatLoadMore: function() {
        return wc_country_select_params.i18n_load_more;
      },
      formatSearching: function() {
        return wc_country_select_params.i18n_searching;
      }
    };
  }

  // Select2 Enhancement if it exists
  if ( $().select2 ) {
    var wc_city_select_select2 = function() {
      $( 'select.city_select:visible' ).each( function() {
        var select2_args = $.extend({
          placeholderOption: 'first',
          width: '100%'
        }, getEnhancedSelectFormatString() );
        $( this ).select2( select2_args );
      });
    };

    wc_city_select_select2();

    $( document.body ).bind( 'city_to_select', function() {
      wc_city_select_select2();
    });
  }

  /* City select boxes */
  var cities_json = wc_city_select_params.cities.replace( /&quot;/g, '"' );
  var cities = $.parseJSON( cities_json );
  var elBodyDPWoo = $( 'body' );

    elBodyDPWoo.on( 'country_to_state_changing', function(e, country, $container) {
    var $statebox = $container.find( '#billing_state, #shipping_state, #calc_shipping_state' );
    var state = $statebox.val();
    $( document.body ).trigger( 'state_changing', [country, state, $container ] );
  });

    elBodyDPWoo.on( 'change', 'select.state_select, #calc_shipping_state', function() {
    var $container = $( this ).closest( 'div' );
    var country = $container.find( '#billing_country, #shipping_country, #calc_shipping_country' ).val();
    var state = $( this ).val();

    $( document.body ).trigger( 'state_changing', [country, state, $container ] );
  });

    elBodyDPWoo.on( 'state_changing', function(e, country, state, $container) {
    var $citybox = $container.find( '#billing_city, #shipping_city, #calc_shipping_city' );

    if ( cities[ country ] ) {
      /* if the country has no states */
      if( cities[country] instanceof Array) {
        cityToSelect( $citybox, cities[ country ] );
      } else if ( state ) {
        if ( cities[ country ][ state ] ) {
          cityToSelect( $citybox, cities[ country ][ state ] );
        } else {
          cityToInput( $citybox );
        }
      } else {
        disableCity( $citybox );
      }
    } else {
      cityToInput( $citybox );
    }
  });

  /* Ajax replaces .cart_totals (child of .cart-collaterals) on shipping calculator */
  if ( $( '.cart-collaterals' ).length && $( '#calc_shipping_state' ).length ) {
    var calc_observer = new MutationObserver( function() {
      $( '#calc_shipping_state' ).change();
    });
    calc_observer.observe( document.querySelector( '.cart-collaterals' ), { childList: true });
  }

  function cityToInput( $citybox ) {
    if ( $citybox.is('input') ) {
      $citybox.prop( 'disabled', false );
      return;
    }

    var input_name = $citybox.attr( 'name' );
    var input_id = $citybox.attr( 'id' );
    var placeholder = $citybox.attr( 'placeholder' );

    $citybox.parent().find( '.select2-container' ).remove();

    $citybox.replaceWith( '<input type="text" class="input-text" name="' + input_name + '" id="' + input_id + '" placeholder="' + placeholder + '" />' );
  }

  function disableCity( $citybox ) {
    $citybox.val( '' ).change();
    $citybox.prop( 'disabled', true );
  }


  function cityToSelect( $citybox, current_cities ) {

    var value = $citybox.val();

    if ( $citybox.is('input') ) {
      var input_name = $citybox.attr( 'name' );
      var input_id = $citybox.attr( 'id' );
      var placeholder = $citybox.attr( 'placeholder' );

      $citybox.replaceWith( '<select name="' + input_name + '" id="' + input_id + '" class="city_select" placeholder="' + placeholder + '"></select>' );
      //we have to assign the new object, because of replaceWith
      $citybox = $('#'+input_id);
    } else {
      $citybox.prop( 'disabled', false );
    }

    var options = '';
    for( var index in current_cities ) {
      if ( current_cities.hasOwnProperty( index ) ) {
        var cityName = current_cities[ index ];
        options = options + '<option data-code="' + cityName + '" value="' + cityName + '">' + cityName + '</option>';
      }
    }

    $citybox.html( '<option data-code="' + wc_city_select_params.i18n_select_city_text + '" value="">' + wc_city_select_params.i18n_select_city_text + '</option>' + options );

    if ( $('option[value="'+value+'"]', $citybox).length ) {
      $citybox.val( value ).change();
    } else {
      $citybox.val( '' ).change();
    }

    $( document.body ).trigger( 'city_to_select' );

    if ( $( '#billing_state').length ) {
      options_to_order = document.getElementById( 'billing_state' );
      option_selected = $('#billing_state').val();
      orderSelectOptionsAlphabetically( options_to_order );
      $('#billing_state').val( option_selected );
    }

    if ( $( '#billing_city').length ) {
      options_to_order = document.getElementById( 'billing_city' );
      option_selected = $('#billing_city').val();
      orderSelectOptionsAlphabetically( options_to_order );
      $('#billing_city').val( option_selected );
    }

    if ( $( '#shipping_state').length ) {
      options_to_order = document.getElementById( 'shipping_state' );
      option_selected = $('#shipping_state').val();
      orderSelectOptionsAlphabetically( options_to_order );
      $('#shipping_state').val( option_selected );
    }

    if ( $( '#shipping_city').length ) {
      options_to_order = document.getElementById( 'shipping_city' );
      option_selected = $('#shipping_city').val();
      orderSelectOptionsAlphabetically( options_to_order );
      $('#shipping_city').val( option_selected );
    }

  }

  function orderSelectOptionsAlphabetically( selElem ) {
    var tmpAry = new Array();
    var tmpAry0 = new Array();
    var tmpAry_index = 0;
    for (var i=0;i<selElem.options.length;i++) {
      if( selElem.options[i].value != "" ) {
        tmpAry[tmpAry_index] = new Array();
        tmpAry[tmpAry_index][0] = selElem.options[i].text;
        tmpAry[tmpAry_index][1] = selElem.options[i].value;
        tmpAry_index++;
      } else {
        tmpAry0[0] = selElem.options[i].text;
        tmpAry0[1] = selElem.options[i].value;
      }
    }
    tmpAry.sort();
    while (selElem.options.length > 0) {
        selElem.options[0] = null;
    }
    for (var i=0;i<tmpAry.length;i++) {
        var op = new Option(tmpAry[i][0], tmpAry[i][1]);
        selElem.options[i] = op;
    }
    selElem.prepend( new Option( tmpAry0[0], tmpAry0[1]) );
    return;
  }

})(jQuery);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInBsYWNlLXNlbGVjdC5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EiLCJmaWxlIjoicGxhY2Utc2VsZWN0Lm1pbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIiggZnVuY3Rpb24oJCkge1xyXG5cclxuICAvLyB3Y19jaXR5X3NlbGVjdF9wYXJhbXMgaXMgcmVxdWlyZWQgdG8gY29udGludWUsIGVuc3VyZSB0aGUgb2JqZWN0IGV4aXN0c1xyXG4gIC8vIHdjX2NvdW50cnlfc2VsZWN0X3BhcmFtcyBpcyB1c2VkIGZvciBzZWxlY3QyIHRleHRzLiBUaGlzIG9uZSBpcyBhZGRlZCBieSBXQ1xyXG4gIGlmICggdHlwZW9mIHdjX2NvdW50cnlfc2VsZWN0X3BhcmFtcyA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mIHdjX2NpdHlfc2VsZWN0X3BhcmFtcyA9PT0gJ3VuZGVmaW5lZCcgKSB7XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiBnZXRFbmhhbmNlZFNlbGVjdEZvcm1hdFN0cmluZygpIHtcclxuICAgICAgcmV0dXJuICB7XHJcbiAgICAgIGZvcm1hdE1hdGNoZXM6IGZ1bmN0aW9uKCBtYXRjaGVzICkge1xyXG4gICAgICAgIGlmICggMSA9PT0gbWF0Y2hlcyApIHtcclxuICAgICAgICAgIHJldHVybiB3Y19jb3VudHJ5X3NlbGVjdF9wYXJhbXMuaTE4bl9tYXRjaGVzXzE7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gd2NfY291bnRyeV9zZWxlY3RfcGFyYW1zLmkxOG5fbWF0Y2hlc19uLnJlcGxhY2UoICclcXR5JScsIG1hdGNoZXMgKTtcclxuICAgICAgfSxcclxuICAgICAgZm9ybWF0Tm9NYXRjaGVzOiBmdW5jdGlvbigpIHtcclxuICAgICAgICByZXR1cm4gd2NfY291bnRyeV9zZWxlY3RfcGFyYW1zLmkxOG5fbm9fbWF0Y2hlcztcclxuICAgICAgfSxcclxuICAgICAgZm9ybWF0QWpheEVycm9yOiBmdW5jdGlvbigpIHtcclxuICAgICAgICByZXR1cm4gd2NfY291bnRyeV9zZWxlY3RfcGFyYW1zLmkxOG5fYWpheF9lcnJvcjtcclxuICAgICAgfSxcclxuICAgICAgZm9ybWF0SW5wdXRUb29TaG9ydDogZnVuY3Rpb24oIGlucHV0LCBtaW4gKSB7XHJcbiAgICAgICAgdmFyIG51bWJlciA9IG1pbiAtIGlucHV0Lmxlbmd0aDtcclxuXHJcbiAgICAgICAgaWYgKCAxID09PSBudW1iZXIgKSB7XHJcbiAgICAgICAgICByZXR1cm4gd2NfY291bnRyeV9zZWxlY3RfcGFyYW1zLmkxOG5faW5wdXRfdG9vX3Nob3J0XzE7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gd2NfY291bnRyeV9zZWxlY3RfcGFyYW1zLmkxOG5faW5wdXRfdG9vX3Nob3J0X24ucmVwbGFjZSggJyVxdHklJywgbnVtYmVyICk7XHJcbiAgICAgIH0sXHJcbiAgICAgIGZvcm1hdElucHV0VG9vTG9uZzogZnVuY3Rpb24oIGlucHV0LCBtYXggKSB7XHJcbiAgICAgICAgdmFyIG51bWJlciA9IGlucHV0Lmxlbmd0aCAtIG1heDtcclxuXHJcbiAgICAgICAgaWYgKCAxID09PSBudW1iZXIgKSB7XHJcbiAgICAgICAgICByZXR1cm4gd2NfY291bnRyeV9zZWxlY3RfcGFyYW1zLmkxOG5faW5wdXRfdG9vX2xvbmdfMTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB3Y19jb3VudHJ5X3NlbGVjdF9wYXJhbXMuaTE4bl9pbnB1dF90b29fbG9uZ19uLnJlcGxhY2UoICclcXR5JScsIG51bWJlciApO1xyXG4gICAgICB9LFxyXG4gICAgICBmb3JtYXRTZWxlY3Rpb25Ub29CaWc6IGZ1bmN0aW9uKCBsaW1pdCApIHtcclxuICAgICAgICBpZiAoIDEgPT09IGxpbWl0ICkge1xyXG4gICAgICAgICAgcmV0dXJuIHdjX2NvdW50cnlfc2VsZWN0X3BhcmFtcy5pMThuX3NlbGVjdGlvbl90b29fbG9uZ18xO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHdjX2NvdW50cnlfc2VsZWN0X3BhcmFtcy5pMThuX3NlbGVjdGlvbl90b29fbG9uZ19uLnJlcGxhY2UoICclcXR5JScsIGxpbWl0ICk7XHJcbiAgICAgIH0sXHJcbiAgICAgIGZvcm1hdExvYWRNb3JlOiBmdW5jdGlvbigpIHtcclxuICAgICAgICByZXR1cm4gd2NfY291bnRyeV9zZWxlY3RfcGFyYW1zLmkxOG5fbG9hZF9tb3JlO1xyXG4gICAgICB9LFxyXG4gICAgICBmb3JtYXRTZWFyY2hpbmc6IGZ1bmN0aW9uKCkge1xyXG4gICAgICAgIHJldHVybiB3Y19jb3VudHJ5X3NlbGVjdF9wYXJhbXMuaTE4bl9zZWFyY2hpbmc7XHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgfVxyXG5cclxuICAvLyBTZWxlY3QyIEVuaGFuY2VtZW50IGlmIGl0IGV4aXN0c1xyXG4gIGlmICggJCgpLnNlbGVjdDIgKSB7XHJcbiAgICB2YXIgd2NfY2l0eV9zZWxlY3Rfc2VsZWN0MiA9IGZ1bmN0aW9uKCkge1xyXG4gICAgICAkKCAnc2VsZWN0LmNpdHlfc2VsZWN0OnZpc2libGUnICkuZWFjaCggZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgdmFyIHNlbGVjdDJfYXJncyA9ICQuZXh0ZW5kKHtcclxuICAgICAgICAgIHBsYWNlaG9sZGVyT3B0aW9uOiAnZmlyc3QnLFxyXG4gICAgICAgICAgd2lkdGg6ICcxMDAlJ1xyXG4gICAgICAgIH0sIGdldEVuaGFuY2VkU2VsZWN0Rm9ybWF0U3RyaW5nKCkgKTtcclxuICAgICAgICAkKCB0aGlzICkuc2VsZWN0Miggc2VsZWN0Ml9hcmdzICk7XHJcbiAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICB3Y19jaXR5X3NlbGVjdF9zZWxlY3QyKCk7XHJcblxyXG4gICAgJCggZG9jdW1lbnQuYm9keSApLmJpbmQoICdjaXR5X3RvX3NlbGVjdCcsIGZ1bmN0aW9uKCkge1xyXG4gICAgICB3Y19jaXR5X3NlbGVjdF9zZWxlY3QyKCk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qIENpdHkgc2VsZWN0IGJveGVzICovXHJcbiAgdmFyIGNpdGllc19qc29uID0gd2NfY2l0eV9zZWxlY3RfcGFyYW1zLmNpdGllcy5yZXBsYWNlKCAvJnF1b3Q7L2csICdcIicgKTtcclxuICB2YXIgY2l0aWVzID0gJC5wYXJzZUpTT04oIGNpdGllc19qc29uICk7XHJcbiAgdmFyIGVsQm9keURQV29vID0gJCggJ2JvZHknICk7XHJcblxyXG4gICAgZWxCb2R5RFBXb28ub24oICdjb3VudHJ5X3RvX3N0YXRlX2NoYW5naW5nJywgZnVuY3Rpb24oZSwgY291bnRyeSwgJGNvbnRhaW5lcikge1xyXG4gICAgdmFyICRzdGF0ZWJveCA9ICRjb250YWluZXIuZmluZCggJyNiaWxsaW5nX3N0YXRlLCAjc2hpcHBpbmdfc3RhdGUsICNjYWxjX3NoaXBwaW5nX3N0YXRlJyApO1xyXG4gICAgdmFyIHN0YXRlID0gJHN0YXRlYm94LnZhbCgpO1xyXG4gICAgJCggZG9jdW1lbnQuYm9keSApLnRyaWdnZXIoICdzdGF0ZV9jaGFuZ2luZycsIFtjb3VudHJ5LCBzdGF0ZSwgJGNvbnRhaW5lciBdICk7XHJcbiAgfSk7XHJcblxyXG4gICAgZWxCb2R5RFBXb28ub24oICdjaGFuZ2UnLCAnc2VsZWN0LnN0YXRlX3NlbGVjdCwgI2NhbGNfc2hpcHBpbmdfc3RhdGUnLCBmdW5jdGlvbigpIHtcclxuICAgIHZhciAkY29udGFpbmVyID0gJCggdGhpcyApLmNsb3Nlc3QoICdkaXYnICk7XHJcbiAgICB2YXIgY291bnRyeSA9ICRjb250YWluZXIuZmluZCggJyNiaWxsaW5nX2NvdW50cnksICNzaGlwcGluZ19jb3VudHJ5LCAjY2FsY19zaGlwcGluZ19jb3VudHJ5JyApLnZhbCgpO1xyXG4gICAgdmFyIHN0YXRlID0gJCggdGhpcyApLnZhbCgpO1xyXG5cclxuICAgICQoIGRvY3VtZW50LmJvZHkgKS50cmlnZ2VyKCAnc3RhdGVfY2hhbmdpbmcnLCBbY291bnRyeSwgc3RhdGUsICRjb250YWluZXIgXSApO1xyXG4gIH0pO1xyXG5cclxuICAgIGVsQm9keURQV29vLm9uKCAnc3RhdGVfY2hhbmdpbmcnLCBmdW5jdGlvbihlLCBjb3VudHJ5LCBzdGF0ZSwgJGNvbnRhaW5lcikge1xyXG4gICAgdmFyICRjaXR5Ym94ID0gJGNvbnRhaW5lci5maW5kKCAnI2JpbGxpbmdfY2l0eSwgI3NoaXBwaW5nX2NpdHksICNjYWxjX3NoaXBwaW5nX2NpdHknICk7XHJcblxyXG4gICAgaWYgKCBjaXRpZXNbIGNvdW50cnkgXSApIHtcclxuICAgICAgLyogaWYgdGhlIGNvdW50cnkgaGFzIG5vIHN0YXRlcyAqL1xyXG4gICAgICBpZiggY2l0aWVzW2NvdW50cnldIGluc3RhbmNlb2YgQXJyYXkpIHtcclxuICAgICAgICBjaXR5VG9TZWxlY3QoICRjaXR5Ym94LCBjaXRpZXNbIGNvdW50cnkgXSApO1xyXG4gICAgICB9IGVsc2UgaWYgKCBzdGF0ZSApIHtcclxuICAgICAgICBpZiAoIGNpdGllc1sgY291bnRyeSBdWyBzdGF0ZSBdICkge1xyXG4gICAgICAgICAgY2l0eVRvU2VsZWN0KCAkY2l0eWJveCwgY2l0aWVzWyBjb3VudHJ5IF1bIHN0YXRlIF0gKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgY2l0eVRvSW5wdXQoICRjaXR5Ym94ICk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGRpc2FibGVDaXR5KCAkY2l0eWJveCApO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjaXR5VG9JbnB1dCggJGNpdHlib3ggKTtcclxuICAgIH1cclxuICB9KTtcclxuXHJcbiAgLyogQWpheCByZXBsYWNlcyAuY2FydF90b3RhbHMgKGNoaWxkIG9mIC5jYXJ0LWNvbGxhdGVyYWxzKSBvbiBzaGlwcGluZyBjYWxjdWxhdG9yICovXHJcbiAgaWYgKCAkKCAnLmNhcnQtY29sbGF0ZXJhbHMnICkubGVuZ3RoICYmICQoICcjY2FsY19zaGlwcGluZ19zdGF0ZScgKS5sZW5ndGggKSB7XHJcbiAgICB2YXIgY2FsY19vYnNlcnZlciA9IG5ldyBNdXRhdGlvbk9ic2VydmVyKCBmdW5jdGlvbigpIHtcclxuICAgICAgJCggJyNjYWxjX3NoaXBwaW5nX3N0YXRlJyApLmNoYW5nZSgpO1xyXG4gICAgfSk7XHJcbiAgICBjYWxjX29ic2VydmVyLm9ic2VydmUoIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoICcuY2FydC1jb2xsYXRlcmFscycgKSwgeyBjaGlsZExpc3Q6IHRydWUgfSk7XHJcbiAgfVxyXG5cclxuICBmdW5jdGlvbiBjaXR5VG9JbnB1dCggJGNpdHlib3ggKSB7XHJcbiAgICBpZiAoICRjaXR5Ym94LmlzKCdpbnB1dCcpICkge1xyXG4gICAgICAkY2l0eWJveC5wcm9wKCAnZGlzYWJsZWQnLCBmYWxzZSApO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgdmFyIGlucHV0X25hbWUgPSAkY2l0eWJveC5hdHRyKCAnbmFtZScgKTtcclxuICAgIHZhciBpbnB1dF9pZCA9ICRjaXR5Ym94LmF0dHIoICdpZCcgKTtcclxuICAgIHZhciBwbGFjZWhvbGRlciA9ICRjaXR5Ym94LmF0dHIoICdwbGFjZWhvbGRlcicgKTtcclxuXHJcbiAgICAkY2l0eWJveC5wYXJlbnQoKS5maW5kKCAnLnNlbGVjdDItY29udGFpbmVyJyApLnJlbW92ZSgpO1xyXG5cclxuICAgICRjaXR5Ym94LnJlcGxhY2VXaXRoKCAnPGlucHV0IHR5cGU9XCJ0ZXh0XCIgY2xhc3M9XCJpbnB1dC10ZXh0XCIgbmFtZT1cIicgKyBpbnB1dF9uYW1lICsgJ1wiIGlkPVwiJyArIGlucHV0X2lkICsgJ1wiIHBsYWNlaG9sZGVyPVwiJyArIHBsYWNlaG9sZGVyICsgJ1wiIC8+JyApO1xyXG4gIH1cclxuXHJcbiAgZnVuY3Rpb24gZGlzYWJsZUNpdHkoICRjaXR5Ym94ICkge1xyXG4gICAgJGNpdHlib3gudmFsKCAnJyApLmNoYW5nZSgpO1xyXG4gICAgJGNpdHlib3gucHJvcCggJ2Rpc2FibGVkJywgdHJ1ZSApO1xyXG4gIH1cclxuXHJcblxyXG4gIGZ1bmN0aW9uIGNpdHlUb1NlbGVjdCggJGNpdHlib3gsIGN1cnJlbnRfY2l0aWVzICkge1xyXG5cclxuICAgIHZhciB2YWx1ZSA9ICRjaXR5Ym94LnZhbCgpO1xyXG5cclxuICAgIGlmICggJGNpdHlib3guaXMoJ2lucHV0JykgKSB7XHJcbiAgICAgIHZhciBpbnB1dF9uYW1lID0gJGNpdHlib3guYXR0ciggJ25hbWUnICk7XHJcbiAgICAgIHZhciBpbnB1dF9pZCA9ICRjaXR5Ym94LmF0dHIoICdpZCcgKTtcclxuICAgICAgdmFyIHBsYWNlaG9sZGVyID0gJGNpdHlib3guYXR0ciggJ3BsYWNlaG9sZGVyJyApO1xyXG5cclxuICAgICAgJGNpdHlib3gucmVwbGFjZVdpdGgoICc8c2VsZWN0IG5hbWU9XCInICsgaW5wdXRfbmFtZSArICdcIiBpZD1cIicgKyBpbnB1dF9pZCArICdcIiBjbGFzcz1cImNpdHlfc2VsZWN0XCIgcGxhY2Vob2xkZXI9XCInICsgcGxhY2Vob2xkZXIgKyAnXCI+PC9zZWxlY3Q+JyApO1xyXG4gICAgICAvL3dlIGhhdmUgdG8gYXNzaWduIHRoZSBuZXcgb2JqZWN0LCBiZWNhdXNlIG9mIHJlcGxhY2VXaXRoXHJcbiAgICAgICRjaXR5Ym94ID0gJCgnIycraW5wdXRfaWQpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgJGNpdHlib3gucHJvcCggJ2Rpc2FibGVkJywgZmFsc2UgKTtcclxuICAgIH1cclxuXHJcbiAgICB2YXIgb3B0aW9ucyA9ICcnO1xyXG4gICAgZm9yKCB2YXIgaW5kZXggaW4gY3VycmVudF9jaXRpZXMgKSB7XHJcbiAgICAgIGlmICggY3VycmVudF9jaXRpZXMuaGFzT3duUHJvcGVydHkoIGluZGV4ICkgKSB7XHJcbiAgICAgICAgdmFyIGNpdHlOYW1lID0gY3VycmVudF9jaXRpZXNbIGluZGV4IF07XHJcbiAgICAgICAgb3B0aW9ucyA9IG9wdGlvbnMgKyAnPG9wdGlvbiBkYXRhLWNvZGU9XCInICsgY2l0eU5hbWUgKyAnXCIgdmFsdWU9XCInICsgY2l0eU5hbWUgKyAnXCI+JyArIGNpdHlOYW1lICsgJzwvb3B0aW9uPic7XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICAkY2l0eWJveC5odG1sKCAnPG9wdGlvbiBkYXRhLWNvZGU9XCInICsgd2NfY2l0eV9zZWxlY3RfcGFyYW1zLmkxOG5fc2VsZWN0X2NpdHlfdGV4dCArICdcIiB2YWx1ZT1cIlwiPicgKyB3Y19jaXR5X3NlbGVjdF9wYXJhbXMuaTE4bl9zZWxlY3RfY2l0eV90ZXh0ICsgJzwvb3B0aW9uPicgKyBvcHRpb25zICk7XHJcblxyXG4gICAgaWYgKCAkKCdvcHRpb25bdmFsdWU9XCInK3ZhbHVlKydcIl0nLCAkY2l0eWJveCkubGVuZ3RoICkge1xyXG4gICAgICAkY2l0eWJveC52YWwoIHZhbHVlICkuY2hhbmdlKCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICAkY2l0eWJveC52YWwoICcnICkuY2hhbmdlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgJCggZG9jdW1lbnQuYm9keSApLnRyaWdnZXIoICdjaXR5X3RvX3NlbGVjdCcgKTtcclxuXHJcbiAgICBpZiAoICQoICcjYmlsbGluZ19zdGF0ZScpLmxlbmd0aCApIHtcclxuICAgICAgb3B0aW9uc190b19vcmRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCAnYmlsbGluZ19zdGF0ZScgKTtcclxuICAgICAgb3B0aW9uX3NlbGVjdGVkID0gJCgnI2JpbGxpbmdfc3RhdGUnKS52YWwoKTtcclxuICAgICAgb3JkZXJTZWxlY3RPcHRpb25zQWxwaGFiZXRpY2FsbHkoIG9wdGlvbnNfdG9fb3JkZXIgKTtcclxuICAgICAgJCgnI2JpbGxpbmdfc3RhdGUnKS52YWwoIG9wdGlvbl9zZWxlY3RlZCApO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICggJCggJyNiaWxsaW5nX2NpdHknKS5sZW5ndGggKSB7XHJcbiAgICAgIG9wdGlvbnNfdG9fb3JkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggJ2JpbGxpbmdfY2l0eScgKTtcclxuICAgICAgb3B0aW9uX3NlbGVjdGVkID0gJCgnI2JpbGxpbmdfY2l0eScpLnZhbCgpO1xyXG4gICAgICBvcmRlclNlbGVjdE9wdGlvbnNBbHBoYWJldGljYWxseSggb3B0aW9uc190b19vcmRlciApO1xyXG4gICAgICAkKCcjYmlsbGluZ19jaXR5JykudmFsKCBvcHRpb25fc2VsZWN0ZWQgKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoICQoICcjc2hpcHBpbmdfc3RhdGUnKS5sZW5ndGggKSB7XHJcbiAgICAgIG9wdGlvbnNfdG9fb3JkZXIgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCggJ3NoaXBwaW5nX3N0YXRlJyApO1xyXG4gICAgICBvcHRpb25fc2VsZWN0ZWQgPSAkKCcjc2hpcHBpbmdfc3RhdGUnKS52YWwoKTtcclxuICAgICAgb3JkZXJTZWxlY3RPcHRpb25zQWxwaGFiZXRpY2FsbHkoIG9wdGlvbnNfdG9fb3JkZXIgKTtcclxuICAgICAgJCgnI3NoaXBwaW5nX3N0YXRlJykudmFsKCBvcHRpb25fc2VsZWN0ZWQgKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoICQoICcjc2hpcHBpbmdfY2l0eScpLmxlbmd0aCApIHtcclxuICAgICAgb3B0aW9uc190b19vcmRlciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCAnc2hpcHBpbmdfY2l0eScgKTtcclxuICAgICAgb3B0aW9uX3NlbGVjdGVkID0gJCgnI3NoaXBwaW5nX2NpdHknKS52YWwoKTtcclxuICAgICAgb3JkZXJTZWxlY3RPcHRpb25zQWxwaGFiZXRpY2FsbHkoIG9wdGlvbnNfdG9fb3JkZXIgKTtcclxuICAgICAgJCgnI3NoaXBwaW5nX2NpdHknKS52YWwoIG9wdGlvbl9zZWxlY3RlZCApO1xyXG4gICAgfVxyXG5cclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIG9yZGVyU2VsZWN0T3B0aW9uc0FscGhhYmV0aWNhbGx5KCBzZWxFbGVtICkge1xyXG4gICAgdmFyIHRtcEFyeSA9IG5ldyBBcnJheSgpO1xyXG4gICAgdmFyIHRtcEFyeTAgPSBuZXcgQXJyYXkoKTtcclxuICAgIHZhciB0bXBBcnlfaW5kZXggPSAwO1xyXG4gICAgZm9yICh2YXIgaT0wO2k8c2VsRWxlbS5vcHRpb25zLmxlbmd0aDtpKyspIHtcclxuICAgICAgaWYoIHNlbEVsZW0ub3B0aW9uc1tpXS52YWx1ZSAhPSBcIlwiICkge1xyXG4gICAgICAgIHRtcEFyeVt0bXBBcnlfaW5kZXhdID0gbmV3IEFycmF5KCk7XHJcbiAgICAgICAgdG1wQXJ5W3RtcEFyeV9pbmRleF1bMF0gPSBzZWxFbGVtLm9wdGlvbnNbaV0udGV4dDtcclxuICAgICAgICB0bXBBcnlbdG1wQXJ5X2luZGV4XVsxXSA9IHNlbEVsZW0ub3B0aW9uc1tpXS52YWx1ZTtcclxuICAgICAgICB0bXBBcnlfaW5kZXgrKztcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0bXBBcnkwWzBdID0gc2VsRWxlbS5vcHRpb25zW2ldLnRleHQ7XHJcbiAgICAgICAgdG1wQXJ5MFsxXSA9IHNlbEVsZW0ub3B0aW9uc1tpXS52YWx1ZTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gICAgdG1wQXJ5LnNvcnQoKTtcclxuICAgIHdoaWxlIChzZWxFbGVtLm9wdGlvbnMubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIHNlbEVsZW0ub3B0aW9uc1swXSA9IG51bGw7XHJcbiAgICB9XHJcbiAgICBmb3IgKHZhciBpPTA7aTx0bXBBcnkubGVuZ3RoO2krKykge1xyXG4gICAgICAgIHZhciBvcCA9IG5ldyBPcHRpb24odG1wQXJ5W2ldWzBdLCB0bXBBcnlbaV1bMV0pO1xyXG4gICAgICAgIHNlbEVsZW0ub3B0aW9uc1tpXSA9IG9wO1xyXG4gICAgfVxyXG4gICAgc2VsRWxlbS5wcmVwZW5kKCBuZXcgT3B0aW9uKCB0bXBBcnkwWzBdLCB0bXBBcnkwWzFdKSApO1xyXG4gICAgcmV0dXJuO1xyXG4gIH1cclxuXHJcbn0pKGpRdWVyeSk7Il19